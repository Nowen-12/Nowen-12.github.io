<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Statistiques Racine Dor√©e</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', Arial, sans-serif;
            background: linear-gradient(120deg, #f6f4ee 60%, #fceabb 100%);
            margin: 0;
            min-height: 100vh;
            color: #5c4d15;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 36px 12px;
        }
        h1 {
            font-size: 2em;
            color: #bfa24a;
            text-align: center;
            margin-bottom: 32px;
            letter-spacing: 1px;
        }
        .chart-section, .matrix-section {
            background: #fffbe7;
            border-radius: 18px;
            box-shadow: 0 4px 16px #ecd97f44, 0 1px 4px #f0e9d2;
            padding: 2em 1em;
            margin-bottom: 32px;
        }
        canvas {
            max-width: 100%;
            height: auto !important;
        }
        .comment-section {
            background: #fffbe7;
            border-radius: 18px;
            box-shadow: 0 4px 16px #ecd97f44, 0 1px 4px #f0e9d2;
            padding: 2em 1em;
        }
        .comment {
            margin-bottom: 1.2em;
            border-bottom: 1px solid #ecd97f88;
            padding-bottom: 0.7em;
        }
        .comment:last-child {
            border-bottom: none;
        }
        .note-emoji {
            font-size: 1.35em;
            margin: 0 0.4em;
        }
    </style>
    <!-- Chart.js + Matrix plugin, UMD, dans cet ordre -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@4.0.1/dist/chartjs-chart-matrix.umd.js"></script>
    <!-- Firebase UMD -->
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <h1>Statistiques de Racine Dor√©e</h1>
        <div class="chart-section">
            <canvas id="notesChart" width="400" height="220"></canvas>
            <div id="statsInfo" style="margin-top:2em; text-align:center;"></div>
        </div>
        <div class="matrix-section">
            <h2 style="text-align:center;color:#bfa24a;">R√©partition des notes Go√ªt par tranche d'√¢ge</h2>
            <canvas id="matrixChart" width="400" height="320"></canvas>
            <div id="matrixLegend" style="text-align:center;font-size:0.95em;margin-top:0.6em;color:#bfa24a;">
                <span style="background:#ffca63;border-radius:5px;padding:2px 8px;">Nombre d'avis, plus la couleur est fonc√©e, plus il y a de votes</span>
            </div>
        </div>
        <div class="comment-section">
            <h2 style="text-align:center; color:#bfa24a;">Derniers avis</h2>
            <div id="comments"></div>
        </div>
    </div>
    <script>
        // --- Firebase config UMD ---
        const firebaseConfig = {
            apiKey: "AIzaSyDeS8UJ0M688FRWtTHm0aYrt_v1r5mlbIo",
            authDomain: "gingerform.firebaseapp.com",
            projectId: "gingerform",
            storageBucket: "gingerform.firebasestorage.app",
            messagingSenderId: "215283939680",
            appId: "1:215283939680:web:2835759898fbc524fb0605",
            measurementId: "G-LGG78H2T8G"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const goutEmojis = ["ü§¢","üò£","üòñ","üòï","üòê","üôÇ","üòä","üòã","üòç","ü§©","üçª"];
        const logoEmojis = ["üí©","üôà","üòë","üòï","üòê","üôÇ","üëç","üòç","ü§©","üåü","üèÜ"];

        let notesChartInstance = null;
        let matrixChartInstance = null;

        function moyenne(arr) {
            return arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : 0;
        }
        function distribution(arr) {
            const dist = Array(11).fill(0);
            arr.forEach(val => dist[val]++);
            return dist;
        }

        function updateStats(notes) {
            const goutNotes = notes.map(function(n){return n.gout;});
            const logoNotes = notes.map(function(n){return n.logo;});

            // Histogramme
            const ctx = document.getElementById('notesChart').getContext('2d');
            if (notesChartInstance) {
                notesChartInstance.destroy();
                notesChartInstance = null;
            }
            notesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length:11},function(_,i){return i;}),
                    datasets: [
                        {
                            label: "Go√ªt de la bi√®re",
                            data: distribution(goutNotes),
                            backgroundColor: "#ffca63"
                        },
                        {
                            label: "Logo",
                            data: distribution(logoNotes),
                            backgroundColor: "#bfa24a"
                        }
                    ]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Note (/10)' } },
                        y: { title: { display: true, text: 'Nombre de votes' }, beginAtZero: true }
                    }
                }
            });

            // Moyennes et totaux
            document.getElementById('statsInfo').innerHTML =
                '<span class="note-emoji">'+goutEmojis[Math.round(moyenne(goutNotes))]+'</span>'
                + ' Moyenne go√ªt : <b>'+moyenne(goutNotes)+' / 10</b> &nbsp; | &nbsp; '
                + '<span class="note-emoji">'+logoEmojis[Math.round(moyenne(logoNotes))]+'</span>'
                + ' Moyenne logo : <b>'+moyenne(logoNotes)+' / 10</b> <br>'
                + 'Nombre d\'avis : <b>'+notes.length+'</b>';

            // --- Matrix chart : Go√ªt vs √¢ge ---
            const ageBins = [
                {min:10, max:15, label:"10-15"},
                {min:16, max:19, label:"16-19"},
                {min:20, max:29, label:"20-29"},
                {min:30, max:39, label:"30-39"},
                {min:40, max:49, label:"40-49"},
                {min:50, max:59, label:"50-59"},
                {min:60, max:100, label:"60+"}
            ];
            const notesMatrix = Array(ageBins.length).fill(0).map(function(){return Array(11).fill(0);});
            notes.forEach(function(n) {
                if (typeof n.age === "number" && typeof n.gout === "number") {
                    var ageIdx = ageBins.findIndex(function(bin){return n.age>=bin.min && n.age<=bin.max;});
                    if (ageIdx>-1 && n.gout>=0 && n.gout<=10) notesMatrix[ageIdx][n.gout]++;
                }
            });
            // Format pour Chart.js Matrix
            var matrixData = [];
            for (var i=0; i<ageBins.length; i++) {
                for (var j=0; j<11; j++) {
                    matrixData.push({
                        x: j, // Note
                        y: i, // Tranche d'√¢ge
                        v: notesMatrix[i][j]
                    });
                }
            }
            // Couleur heatmap
            function colorForValue(v) {
                if (v === 0) return '#fffbe7';
                var base = [255, 202, 99]; // jaune p√¢le
                var max = [191, 162, 74]; // dor√© fonc√©
                var ratio = Math.min(1,v/Math.max(1,Math.max.apply(null,notesMatrix.flat())));
                var blend = base.map(function(b, idx) { return Math.round(b + (max[idx]-b)*ratio); });
                return 'rgb('+blend.join(',')+')';
            }
            var matrixCtx = document.getElementById('matrixChart').getContext('2d');
            if (matrixChartInstance) {
                matrixChartInstance.destroy();
                matrixChartInstance = null;
            }
            matrixChartInstance = new Chart(matrixCtx, {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: "Votes Go√ªt par √¢ge",
                        data: matrixData,
                        backgroundColor: function(ctx) {
                            return colorForValue(ctx.dataset.data[ctx.dataIndex].v);
                        },
                        borderColor: "#ecd97f",
                        borderWidth: 1,
                        width: function(context) { return (context.chart.chartArea||{}).width/12; },
                        height: function(context) { return (context.chart.chartArea||{}).height/ageBins.length; }
                    }]
                },
                options: {
                    plugins: {
                        legend: {display:false},
                        tooltip: {
                            callbacks: {
                                title: function(ctx) {
                                    var d = ctx[0].raw;
                                    return 'Note '+d.x+'/10, √¢ge '+ageBins[d.y].label;
                                },
                                label: function(ctx) {
                                    var d = ctx.raw;
                                    return "Nombre d'avis : "+d.v;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            label: "Note go√ªt",
                            min: -0.5, max: 10.5,
                            ticks: {
                                callback: function(val) { return val>=0&&val<=10?val:""; }
                            },
                            title: {display:true, text:"Note Go√ªt (/10)"}
                        },
                        y: {
                            type: 'linear',
                            min: -0.5, max: ageBins.length-0.5,
                            ticks: {
                                callback: function(val) { return ageBins[val]?ageBins[val].label:""; }
                            },
                            title: {display:true, text:"Tranche d'√¢ge"}
                        }
                    }
                }
            });

            // Derniers commentaires
            var commentsHtml = '';
            notes
                .filter(function(n){ return n.commentaire && n.commentaire.length; })
                .sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); }) // plus r√©cents d'abord
                .slice(0,10)
                .forEach(function(n) {
                    commentsHtml +=
                    '<div class="comment">'
                        + '<b>' + ((!n.nom || n.nom === "Anonyme") ? "Anonyme" : n.nom) + '</b> ('+(n.age ? n.age : "?")+' ans)'
                        + '<br>'
                        + '<span class="note-emoji">'+(goutEmojis[n.gout]||"")+'</span>'
                        + 'Go√ªt : <b>'+n.gout+'/10</b> &nbsp; | &nbsp; '
                        + '<span class="note-emoji">'+(logoEmojis[n.logo]||"")+'</span>'
                        + 'Logo : <b>'+n.logo+'/10</b>'
                        + '<br>'
                        + '<span style="color:#5c4d15;">'+n.commentaire+'</span>'
                        + '<br>'
                        + '<span style="font-size:0.8em;color:#bfa24a;">'
                        + (n.date ? new Date(n.date).toLocaleString("fr-FR") : "")
                        + '</span>'
                    + '</div>';
                });
            document.getElementById('comments').innerHTML = commentsHtml || "<i>Aucun commentaire pour l'instant.</i>";
        }

        // --- Ecoute Firestore en temps r√©el ---
        db.collection("notes").onSnapshot(function(snapshot) {
            var notes = [];
            snapshot.forEach(function(doc) { notes.push(doc.data()); });
            updateStats(notes);
        });
    </script>
</body>
</html>
